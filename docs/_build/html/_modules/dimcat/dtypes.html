
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dimcat.dtypes &#8212; dimcat 0.3.0.post1.dev48+gb31e433.d20230210 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for dimcat.dtypes</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Hashable</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">NamedTuple</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeAlias</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">_GenericAlias</span><span class="p">,</span>
    <span class="n">get_args</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">dimcat.utils</span> <span class="kn">import</span> <span class="n">grams</span><span class="p">,</span> <span class="n">transition_matrix</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="PieceID"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.PieceID">[docs]</a><span class="k">class</span> <span class="nc">PieceID</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">corpus</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">piece</span><span class="p">:</span> <span class="nb">str</span></div>


<span class="n">Pandas</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span>
<span class="n">GroupID</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="nb">tuple</span>
<span class="n">SliceID</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">]</span>
<span class="n">ID</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">PieceID</span><span class="p">,</span> <span class="n">SliceID</span><span class="p">]</span>
<span class="n">T_co</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_co&quot;</span><span class="p">,</span> <span class="n">covariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">T_hash</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_hash&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">covariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>  <span class="c1"># convertible</span>
<span class="n">Out</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;Out&quot;</span><span class="p">)</span>  <span class="c1"># output</span>
<span class="n">TS</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;TS&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;TypedSequence&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="TypedSequence"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.TypedSequence">[docs]</a><span class="k">class</span> <span class="nc">TypedSequence</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">T_co</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A TypedSequence behaves like a list in many aspects but with the difference that it</span>
<span class="sd">    imposes one particular data type on its elements.</span>

<span class="sd">    If it is instantiated without a converter, the type will be inferred from the first element:</span>

<span class="sd">        &gt;&gt;&gt; A = TypedSequence([[1], &#39;2&#39;, {7}])</span>
<span class="sd">        TypedSequence[list]([[1], [&#39;2&#39;], [7]])</span>

<span class="sd">    However, this only works if ``type(a)`` yields a constructor, that works on all elements,</span>
<span class="sd">    otherwise a converter needs to be passed:</span>

<span class="sd">        &gt;&gt;&gt; converter = lambda e: (e,)</span>
<span class="sd">        &gt;&gt;&gt; B = TypedSequence([1, 2, 3], converter)</span>
<span class="sd">        TypedSequence[tuple]([(1,), (2,), (3,)])</span>

<span class="sd">    TypedSequences can be nested, i.e. have other TypedSequences as elements. The base class,</span>
<span class="sd">    however, does not enforce equal type parameters on them:</span>

<span class="sd">        &gt;&gt;&gt; C = TypedSequence([A, B, [1, 2.1, 3.9]])</span>
<span class="sd">        TypedSequence[TypedSequence]([TypedSequence[list]([[1], [&#39;2&#39;], [7]]),</span>
<span class="sd">                                      TypedSequence[tuple]([(1,), (2,), (3,)]),</span>
<span class="sd">                                      TypedSequence[int]([1, 2, 3])])</span>

<span class="sd">    The module as a few example of parametrized subtypes. Notably, subtypes can register</span>
<span class="sd">    themselves as default type for instantiating a TypedSequence with a particular first value.</span>
<span class="sd">    This is useful for downcasting to a subclass that has the fitting converter pre-defined.</span>
<span class="sd">    For example, ``PieceIndex`` is defined as</span>

<span class="sd">        &gt;&gt;&gt; class PieceIndex(TypedSequence[PieceID], register_for=[PieceID]):</span>

<span class="sd">    where ``register_for=List[Type]`` makes sure any TypedSequence instantiated</span>
<span class="sd">    **without a custom converter** and with a first element of type ``Type`` will be</span>
<span class="sd">    cast to that subclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_type_parameter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T_co</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores the value of the parametrized type.&quot;&quot;&quot;</span>
    <span class="n">_type2subclass</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">T_co</span><span class="p">],</span> <span class="n">Type</span><span class="p">[</span><span class="n">TypedSequence</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registry of all subclasses that are defined with ``register_for=[type,...]``. Whenever a TypedSequence is</span>
<span class="sd">    initiated without converter, the __new__() method looks at the type of the first value (if any) and, if it</span>
<span class="sd">    is contained in the registry, creates an object from the pertinent subclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">int_or_slice</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">int_or_slice</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">int_or_slice</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> cannot be subscripted with </span><span class="si">{</span><span class="n">int_or_slice</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="TypedSequence.map"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.TypedSequence.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T_co</span><span class="p">],</span> <span class="n">Out</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypedSequence</span><span class="p">[</span><span class="n">Out</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapping </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> onto </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> failed with:</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">sequential</span> <span class="o">=</span> <span class="n">TypedSequence</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sequential</span></div>

<div class="viewcode-block" id="TypedSequence.filtered_by_condition"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.TypedSequence.filtered_by_condition">[docs]</a>    <span class="k">def</span> <span class="nf">filtered_by_condition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T_co</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">T_co</span><span class="p">]:</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">condition</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>

<div class="viewcode-block" id="TypedSequence.get_n_grams"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.TypedSequence.get_n_grams">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_grams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ngrams</span><span class="p">[</span><span class="n">T_co</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns n-gram tuples of the sequence, i.e. all N-(n-1) possible direct successions of n elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_grams</span> <span class="o">=</span> <span class="n">grams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ngrams</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">n_grams</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedSequence.get_transition_matrix"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.TypedSequence.get_transition_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">get_transition_matrix</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">smooth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">entropy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">excluded_symbols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">distinct_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">percent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">decimals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a transition table of n-grams, showing the frequencies with which any subsequence of length n-1</span>
<span class="sd">        is followed by any of the n-grams&#39; last elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            list_of_sequences:</span>
<span class="sd">                List of elements or nested list of elements between which the transitions are calculated. If the list</span>
<span class="sd">                is nested, bigrams are calculated recursively to exclude transitions between the lists. If you want</span>
<span class="sd">                to create the transition matrix from a list of n-grams directly, pass it as ``list_of_grams`` instead.</span>
<span class="sd">            list_of_grams: List of tuples being n-grams. If you want to have them computed from a list of sequences,</span>
<span class="sd">                pass it as ``list_of_sequences`` instead.</span>
<span class="sd">            n: If ``list_of_sequences`` is passed, the number of elements per n-gram tuple. Ignored otherwise.</span>
<span class="sd">            k: If specified, the transition matrix will show only the top k n-grams.</span>
<span class="sd">            smooth: If specified, this is the minimum value in the transition matrix.</span>
<span class="sd">            normalize: By default, absolute counts are shown. Pass True to normalize each row.</span>
<span class="sd">            entropy: Pass True to add a column showing the normalized entropy for each row.</span>
<span class="sd">            excluded_symbols: Any n-gram containing any of these symbols will be excluded.</span>
<span class="sd">            distinct_only: Pass True to exclude all n-grams consisting of identical elements only.</span>
<span class="sd">            sort:</span>
<span class="sd">                By default, the columns are ordered by n-gram frequency.</span>
<span class="sd">                Pass True to sort them separately, i.e. each by their own frequencies.</span>
<span class="sd">            percent: Pass True to multiply the matrix by 100 before rounding to `decimals`</span>
<span class="sd">            decimals: To how many decimals you want to round the matrix, if at all.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with frequency statistics of (n-1) grams transitioning to all occurring last elements.</span>
<span class="sd">            The index is made up of strings corresponding to all but the last element of the n-grams,</span>
<span class="sd">            with the column index containing all last elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">transition_matrix</span><span class="p">(</span>
            <span class="n">list_of_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span>
            <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
            <span class="n">entropy</span><span class="o">=</span><span class="n">entropy</span><span class="p">,</span>
            <span class="n">excluded_symbols</span><span class="o">=</span><span class="n">excluded_symbols</span><span class="p">,</span>
            <span class="n">distinct_only</span><span class="o">=</span><span class="n">distinct_only</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">percent</span><span class="o">=</span><span class="n">percent</span><span class="p">,</span>
            <span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">register_for</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Registers every subclass under the class variable :attr:`_registry`&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">register_for</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">register_for</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_type2subclass</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> had already been registered by </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_type2subclass</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_type2subclass</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">: TypedSequence will default to a [</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">] if first value is </span><span class="si">{</span><span class="n">register_for</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># The following two lines make the value of T available for all parametrized subclasses.</span>
        <span class="c1"># Thanks to Paweł Rubin via https://stackoverflow.com/a/71720366</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_type_parameter</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__orig_bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">._type_parameter = </span><span class="si">{</span><span class="n">get_args</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__orig_bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">T_co</span><span class="p">,</span> <span class="n">C</span><span class="p">]],</span>
        <span class="n">converter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">C</span><span class="p">],</span> <span class="n">T_co</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The first argument needs to be a Sequence, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">nonempty</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">converter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nonempty</span><span class="p">:</span>
            <span class="n">first_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">first_type</span> <span class="ow">in</span> <span class="n">TypedSequence</span><span class="o">.</span><span class="n">_type2subclass</span><span class="p">:</span>
                <span class="n">new_object_type</span> <span class="o">=</span> <span class="n">TypedSequence</span><span class="o">.</span><span class="n">_type2subclass</span><span class="p">[</span><span class="n">first_type</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="n">new_object_type</span><span class="si">}</span><span class="s2"> because </span><span class="si">{</span><span class="n">first_type</span><span class="si">}</span><span class="s2"> is in </span><span class="si">{</span><span class="n">TypedSequence</span><span class="o">.</span><span class="n">_type2subclass</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">new_object_type</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> because </span><span class="si">{</span><span class="n">first_type</span><span class="si">}</span><span class="s2"> is not in </span><span class="si">{</span><span class="n">TypedSequence</span><span class="o">.</span><span class="n">_type2subclass</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">T_co</span><span class="p">],</span> <span class="n">converter</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]):</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">C</span><span class="p">],</span> <span class="n">converter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">C</span><span class="p">],</span> <span class="n">T_co</span><span class="p">]):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">T_co</span><span class="p">,</span> <span class="n">C</span><span class="p">]],</span>
        <span class="n">converter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">C</span><span class="p">],</span> <span class="n">T_co</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sequence object that converts all elements to the same data type.</span>

<span class="sd">        If no converter is passed, it is inferred in two different ways:</span>
<span class="sd">        a) If self is a subclass of TypedSequence that has been parametrized with class T,</span>
<span class="sd">           T is used as a converter. That is, it needs to work as a constructor, which is</span>
<span class="sd">           tested using callable(T). Otherwise:</span>
<span class="sd">        b) As a fallback, the type of the first value is used for the entire sequence.</span>

<span class="sd">        Args:</span>
<span class="sd">            values:</span>
<span class="sd">                The values you want to create the sequence from. If one of them cannot be converted,</span>
<span class="sd">                a TypeError will be thrown.</span>
<span class="sd">            converter: A callable that converts values of all expected/allowed types to T_co.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(values=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">, converter=</span><span class="si">{</span><span class="n">converter</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">T_co</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_converter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">C</span><span class="p">],</span> <span class="n">T_co</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">converter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">converter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">T_co</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span><span class="p">,</span> <span class="p">(</span><span class="n">TypeVar</span><span class="p">,</span> <span class="n">_GenericAlias</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span>

    <span class="nd">@converter</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">converter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">T_co</span><span class="p">]]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_converter</span> <span class="o">=</span> <span class="n">converter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span><span class="p">,</span> <span class="p">(</span><span class="n">TypeVar</span><span class="p">,</span> <span class="n">_GenericAlias</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="s2">&quot;[None]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">T_co</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">)</span>

    <span class="nd">@values</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">T_co</span><span class="p">,</span> <span class="n">C</span><span class="p">]]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>

<div class="viewcode-block" id="TypedSequence.convert"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.TypedSequence.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">T_co</span><span class="p">,</span> <span class="n">C</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">T_co</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this should happen only once in the object&#39;s lifetime</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span><span class="p">),</span>
                    <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_parameter</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Conversion </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">) -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> failed with:</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TypedSequence.append"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.TypedSequence.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">T_co</span><span class="p">,</span> <span class="n">convert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">type_check</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">converted_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The exact dtype of this empty sequence is not yet defined and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> cannot be converted with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">value_type</span><span class="p">,</span> <span class="n">converted_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">converted_value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">value_type</span><span class="p">,</span> <span class="n">converted_type</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;First value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="n">value_type</span><span class="si">}</span><span class="s2"> is compatible with the type &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;yielded by the converter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;This sequence is empty but the first value to be appended, </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;has type </span><span class="si">{</span><span class="n">value_type</span><span class="si">}</span><span class="s2">, which seems to be incompatible with the type &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">converted_type</span><span class="si">}</span><span class="s2"> yielded by the converter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="si">}</span><span class="s2">. Try setting &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;convert=True.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Checking the type of </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> against </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> failed with</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">type_check</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot append </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. Try setting convert=True.&quot;</span>
                <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Considered as equal when &#39;other&#39; is a Sequence containing the same values.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="to_tuple"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.to_tuple">[docs]</a><span class="k">def</span> <span class="nf">to_tuple</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">T_co</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">T_co</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">T_co</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">elem</span><span class="p">,)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">elem</span><span class="p">,)</span></div>


<div class="viewcode-block" id="Ngrams"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.Ngrams">[docs]</a><span class="k">class</span> <span class="nc">Ngrams</span><span class="p">(</span><span class="n">TypedSequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">T_co</span><span class="p">,</span> <span class="o">...</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;N-grams know that they do not need to be converted to n-grams to compute</span>
<span class="sd">    a transition matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">T_co</span><span class="p">]],</span> <span class="n">converter</span><span class="o">=</span><span class="n">to_tuple</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>

<div class="viewcode-block" id="Ngrams.get_transition_matrix"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.Ngrams.get_transition_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">get_transition_matrix</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">smooth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">entropy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">excluded_symbols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">distinct_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">percent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">decimals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a transition table of n-grams, showing the frequencies with which any subsequence of length n-1</span>
<span class="sd">        is followed by any of the n-grams&#39; last elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            list_of_sequences:</span>
<span class="sd">                List of elements or nested list of elements between which the transitions are calculated. If the list</span>
<span class="sd">                is nested, bigrams are calculated recursively to exclude transitions between the lists. If you want</span>
<span class="sd">                to create the transition matrix from a list of n-grams directly, pass it as ``list_of_grams`` instead.</span>
<span class="sd">            list_of_grams: List of tuples being n-grams. If you want to have them computed from a list of sequences,</span>
<span class="sd">                pass it as ``list_of_sequences`` instead.</span>
<span class="sd">            n: If ``list_of_sequences`` is passed, the number of elements per n-gram tuple. Ignored otherwise.</span>
<span class="sd">            k: If specified, the transition matrix will show only the top k n-grams.</span>
<span class="sd">            smooth: If specified, this is the minimum value in the transition matrix.</span>
<span class="sd">            normalize: By default, absolute counts are shown. Pass True to normalize each row.</span>
<span class="sd">            entropy: Pass True to add a column showing the normalized entropy for each row.</span>
<span class="sd">            excluded_symbols: Any n-gram containing any of these symbols will be excluded.</span>
<span class="sd">            distinct_only: Pass True to exclude all n-grams consisting of identical elements only.</span>
<span class="sd">            sort:</span>
<span class="sd">                By default, the columns are ordered by n-gram frequency.</span>
<span class="sd">                Pass True to sort them separately, i.e. each by their own frequencies.</span>
<span class="sd">            percent: Pass True to multiply the matrix by 100 before rounding to `decimals`</span>
<span class="sd">            decimals: To how many decimals you want to round the matrix, if at all.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with frequency statistics of (n-1) grams transitioning to all occurring last elements.</span>
<span class="sd">            The index is made up of strings corresponding to all but the last element of the n-grams,</span>
<span class="sd">            with the column index containing all last elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">transition_matrix</span><span class="p">(</span>
            <span class="n">list_of_grams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span>
            <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
            <span class="n">entropy</span><span class="o">=</span><span class="n">entropy</span><span class="p">,</span>
            <span class="n">excluded_symbols</span><span class="o">=</span><span class="n">excluded_symbols</span><span class="p">,</span>
            <span class="n">distinct_only</span><span class="o">=</span><span class="n">distinct_only</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">percent</span><span class="o">=</span><span class="n">percent</span><span class="p">,</span>
            <span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="Bigrams"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.Bigrams">[docs]</a><span class="k">class</span> <span class="nc">Bigrams</span><span class="p">(</span><span class="n">Ngrams</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">T_co</span><span class="p">,</span> <span class="n">T_co</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ToDo: Need to enforce that tuples are indeed pairs.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="PieceIndex"><a class="viewcode-back" href="../../api/dimcat.html#dimcat.dtypes.PieceIndex">[docs]</a><span class="k">class</span> <span class="nc">PieceIndex</span><span class="p">(</span><span class="n">TypedSequence</span><span class="p">[</span><span class="n">PieceID</span><span class="p">],</span> <span class="n">register_for</span><span class="o">=</span><span class="p">[</span><span class="n">PieceID</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">converter</span><span class="o">=</span><span class="n">PieceID</span><span class="o">.</span><span class="n">_make</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span></div>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">dimcat</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/index.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributions &amp; Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Module Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Digital and Cognitive Musicology Lab @ École Polytechnique Fédérale de Lausanne.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>

    </div>




  </body>
</html>
